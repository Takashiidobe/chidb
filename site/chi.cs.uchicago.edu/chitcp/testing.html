
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Testing your Implementation &#8212; The UChicago χ-Projects</title>

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/chiweb.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="chirouter" href="../chirouter/index.html" />
    <link rel="prev" title="Assignment 2: TCP over an Unreliable Network" href="assignment2.html" />

<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27880910-3', 'auto');
  ga('send', 'pageview');

</script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          The UChicago χ-Projects</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../about.html">About</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Projects <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc">
      
      <li class="toctree-l1"><a class="reference internal" href="../chidb/index.html">chidb</a></li>
      <li class="toctree-l1"><a class="reference internal" href="../chirc/index.html">chirc</a></li>
      <li class="toctree-l1"><a class="reference internal" href="index.html">chiTCP</a></li> 
      <li class="toctree-l1"><a class="reference internal" href="../chirouter/index.html">chirouter</a></li> 
      <li class="toctree-l1"><a class="reference internal" href="../chistributed/index.html">chistributed</a></li>
      <li class="toctree-l1"><a class="reference internal" href="../chisubmit/index.html">chisubmit</a></li>      
  </ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
<div class="row">
    <div class="col-md-12">
        <ul class="breadcrumb">
          <li><a href="../index.html">The UChicago χ-Projects</a></li>
          <li><a href="index.html">chiTCP</a></li>
            <li class="active">Testing your Implementation</li>
        </ul>
    </div>
</div>

    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="testing-your-implementation">
<span id="chitcp-testing"></span><h1>Testing your Implementation<a class="headerlink" href="testing.html#testing-your-implementation" title="Permalink to this headline">¶</a></h1>
<p>We provide a number of automated tests and tools that you can use to
test your implementation.</p>
<div class="section" id="automated-tests">
<h2>Automated tests<a class="headerlink" href="testing.html#automated-tests" title="Permalink to this headline">¶</a></h2>
<p>The tests for chiTCP are built by following the instructions in
<a class="reference internal" href="installing.html#chitcp-building"><span class="std std-ref">Building</span></a>. While this will build several test programs,
you will only have to use the <code class="docutils literal notranslate"><span class="pre">test-tcp</span></code> executable. Make sure
you re-build chiTCP any time you change your code, to make sure
the <code class="docutils literal notranslate"><span class="pre">test-tcp</span></code> executable is testing the latest version of your
code.</p>
<p>The test suite has multiple tests, divided into several categories. You
can see a list of all the tests by running the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./test-tcp -l
</pre></div>
</div>
<p>You can run all the tests by running the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./test-tcp
</pre></div>
</div>
<p>Optionally, you can include the <code class="docutils literal notranslate"><span class="pre">--verbose</span></code> option to see the progress
of each test.</p>
<p>However, you should not do this until your project is nearly complete: most of
the tests will fail by timing out and, given the high timeouts necessary for
some of the tests, the above command can take a long time to run on an
incomplete project. Instead, you should run the tests individually or
by category.</p>
</div>
<div class="section" id="running-and-debugging-individual-tests">
<h2>Running and debugging individual tests<a class="headerlink" href="testing.html#running-and-debugging-individual-tests" title="Permalink to this headline">¶</a></h2>
<p>To run a single test, simply run the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./test-tcp --filter &quot;TEST_CATEGORY/TEST_NAME&quot;
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">TEST_CATEGORY</span></code> is the category of the test, and <code class="docutils literal notranslate"><span class="pre">TEST_NAME</span></code> is the name
of the test (you can see both of these by running <code class="docutils literal notranslate"><span class="pre">tests/test-tcp</span> <span class="pre">-l</span></code>). For example,
this will run the first connection establishment test:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./test-tcp --filter &quot;conn_init/3way_states&quot;
</pre></div>
</div>
<p>If the test is succesful, you will see the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[====] Synthesis: Tested: 1 | Passing: 1 | Failing: 0 | Crashing: 0
</pre></div>
</div>
<p>If the test fails an assertion, a message will be printed out. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[----] tests/test_tcp_conn_init.c:43: Assertion failed: Invalid transition: SYN_SENT -&gt; CLOSED
</pre></div>
</div>
<p>In some tests, you may also see the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[FAIL] conn_init::3way_states: Timed out. (0.50s)
</pre></div>
</div>
<p>This means that the test did not finish running by some specified timeout (in this case, 0.5 seconds).
This usually means your code has gotten stuck somewhere, and is not sending a packet that the
tests were expecting.</p>
<p>When a test fails or times out, you will need to dig deeper to see what your code is
doing during the test. We provide several mechanisms for you to do so.</p>
</div>
<div class="section" id="running-categories-of-tests">
<h2>Running categories of tests<a class="headerlink" href="testing.html#running-categories-of-tests" title="Permalink to this headline">¶</a></h2>
<p>To run entire categories of tests, simply run the following:</p>
<ul>
<li><p>TCP connection establishment:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./test-tcp --filter &quot;conn_init/*&quot;
</pre></div>
</div>
</li>
<li><p>TCP connection termination:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./test-tcp --filter &quot;conn_term/*&quot;
</pre></div>
</div>
</li>
<li><p>TCP data transfer:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./test-tcp --filter &quot;data_transfer/*&quot;
</pre></div>
</div>
</li>
<li><p>Timer API:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./test-tcp --filter &quot;multitimer/*&quot;
</pre></div>
</div>
</li>
<li><p>TCP over an unreliable network:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./test-tcp --filter &quot;unreliable_conn_init/*&quot;
./test-tcp --filter &quot;unreliable_conn_term/*&quot;
./test-tcp --filter &quot;unreliable_data_transfer/*&quot;
./test-tcp --filter &quot;unreliable_out_of_order/*&quot;
</pre></div>
</div>
</li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">--filter</span></code> option uses regular expressions, so you can further constrain the tests
that will be run. For example, to only run the “echo” tests from the data transfer
tests, you could run the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./test-tcp --filter &quot;data_transfer/echo*&quot;
</pre></div>
</div>
</div>
<div class="section" id="producing-a-grade-report">
<h2>Producing a grade report<a class="headerlink" href="testing.html#producing-a-grade-report" title="Permalink to this headline">¶</a></h2>
<p>To produce a grade report (showing how many points were scored in each test),
run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">grade</span></code> in the same directory where you built chiTCP. Make sure
you do so <em>after</em> running the tests (<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">grade</span></code> will not run the tests
for you; it will simply analyze the test results, which are saved to a
<code class="docutils literal notranslate"><span class="pre">results.json</span></code> file by default, and determine your score based on that).</p>
<p>Note: <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">grade</span></code> will still work if you ran the tests just for a subset
of the tests (e.g., by selecting just one category). In this case, any test
that was not run will be reported as scoring zero points.</p>
<div class="section" id="minimal-logging">
<h3>Minimal logging<a class="headerlink" href="testing.html#minimal-logging" title="Permalink to this headline">¶</a></h3>
<p>Parsing through all the detailed logging at the <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> and <code class="docutils literal notranslate"><span class="pre">TRACE</span></code> levels can be overwhelming,
and it can be hard to sift through so much information. You should first try using chiTCP’s
<code class="docutils literal notranslate"><span class="pre">MINIMAL</span></code> logging level (the messages at this level are generated directly by chiTCP; you should
never call <code class="docutils literal notranslate"><span class="pre">chilog</span></code> with this logging level). The <code class="docutils literal notranslate"><span class="pre">MINIMAL</span></code> logging level will log any changes
of state in a socket, as well as any packets received and sent by a socket (including important information
about the packet, like its sequence number, the size of the payload, etc.). The format is compact
and intended to be easy to read.</p>
<p>To run a test with MINIMAL logging, simply include <code class="docutils literal notranslate"><span class="pre">LOG=MINIMAL</span></code> before <code class="docutils literal notranslate"><span class="pre">./test-tcp</span></code>. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>LOG=MINIMAL ./test-tcp --filter &quot;conn_init/3way_states&quot;
</pre></div>
</div>
<p>The output of this test (if successful) would look like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[09:55:41.736394340]     tcp-socket-0 [S0] SENT 127.0.0.1.49152 &gt; 127.0.0.1.7: Flags [S], seq 243, win 4096, length 0
[09:55:41.736794051]     tcp-socket-0 [S0] CLOSED -&gt; SYN_SENT
[09:55:41.736867528]  network-layer-0 [S1] RCVD 127.0.0.1.49152 &gt; 127.0.0.1.7: Flags [S], seq 243, win 4096, length 0
[09:55:41.736902750]   socket-layer-1 [S1] Passive socket has spawned active socket S2
[09:55:41.737130155]     tcp-socket-2 [S2] SENT 127.0.0.1.7 &gt; 127.0.0.1.49152: Flags [S.], seq 11, ack 244, win 4096, length 0
[09:55:41.737174854]     tcp-socket-2 [S2] LISTEN -&gt; SYN_RCVD
[09:55:41.737200234]  network-layer-0 [S0] RCVD 127.0.0.1.7 &gt; 127.0.0.1.49152: Flags [S.], seq 11, ack 244, win 4096, length 0
[09:55:41.737748500]     tcp-socket-0 [S0] SENT 127.0.0.1.49152 &gt; 127.0.0.1.7: Flags [.], seq 244, ack 12, win 4096, length 0
[09:55:41.737779939]     tcp-socket-0 [S0] SYN_SENT -&gt; ESTABLISHED
[09:55:41.737806251]  network-layer-0 [S2] RCVD 127.0.0.1.49152 &gt; 127.0.0.1.7: Flags [.], seq 244, ack 12, win 4096, length 0
[09:55:41.738532355]     tcp-socket-2 [S2] SYN_RCVD -&gt; ESTABLISHED
[09:55:41.740581751]      lt-test-tcp ~~~~~~~~~ chiTCP is shutting down ~~~~~~~~~
[09:55:41.740649209]   socket-layer-0 [S0] ESTABLISHED -&gt; CLOSED
[09:55:41.740846044]   socket-layer-1 [S2] ESTABLISHED -&gt; CLOSED
[09:55:41.741517438]      lt-test-tcp =========  chiTCP has shut down   =========
</pre></div>
</div>
<p>You should ignore the column containing <code class="docutils literal notranslate"><span class="pre">tcp-socket-0</span></code>, <code class="docutils literal notranslate"><span class="pre">network-layer-0</span></code>, etc. Instead focus on the <code class="docutils literal notranslate"><span class="pre">[S0]</span></code>, <code class="docutils literal notranslate"><span class="pre">[S1]</span></code>, etc.
which tells you what socket is producing this log message. The log message can be either <code class="docutils literal notranslate"><span class="pre">SENT</span></code> (the socket sent a packet),
<code class="docutils literal notranslate"><span class="pre">RCVD</span></code> (the socket received a packet), a state transition (two states separated by <code class="docutils literal notranslate"><span class="pre">-&gt;</span></code>, or a message indicating that
a passive socket has spawned an active socket.</p>
<p>Whe a packet is sent or received, the log message will include the source IP and port, the destination IP and port, the
flags in the TCP header (<code class="docutils literal notranslate"><span class="pre">S</span></code>: SYN, <code class="docutils literal notranslate"><span class="pre">F</span></code>: FIN, <code class="docutils literal notranslate"><span class="pre">.</span></code>: ACK), the sequence number, the acknowledgement number,
the advertised window size, and the payload length. Please note that the sequence numbers are likely to be different
that shown in the above output, depending on how you set IRS and ISS.</p>
<p>We also provide a script that will colorize this output for extra readability. Just pipe the output of
the test to <code class="docutils literal notranslate"><span class="pre">tests/colorize-minimal.sh</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>LOG=MINIMAL ./test-tcp --filter &quot;conn_init/3way_states&quot; | ../tests/colorize-minimal.sh
</pre></div>
</div>
<p>You should see something like this:</p>
<img alt="../_images/minimal-color1.png" src="../_images/minimal-color1.png" />
<p>In the tests that involve dropping packets, the <code class="docutils literal notranslate"><span class="pre">colorize-minimal.sh</span></code> script will highlight dropped
packets and timeouts in red. For example, if we run this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>LOG=MINIMAL ./test-tcp --filter &quot;unreliable_data_transfer/drop_single_packet&quot; | ../tests/colorize-minimal.sh
</pre></div>
</div>
<p>The output will look like this:</p>
<img alt="../_images/minimal-color2.png" src="../_images/minimal-color2.png" />
<p>The <code class="docutils literal notranslate"><span class="pre">DROP_RCVD</span></code> message indicates that chiTCP simulated a dropped packet, and <code class="docutils literal notranslate"><span class="pre">TIMEOUT</span></code> indicates that
a TCP timeout has happened.</p>
</div>
<div class="section" id="other-logging-levels">
<h3>Other logging levels<a class="headerlink" href="testing.html#other-logging-levels" title="Permalink to this headline">¶</a></h3>
<p>To have a test print log messages from other log levels, simply set the <code class="docutils literal notranslate"><span class="pre">LOG</span></code> variable to the appropriate
level. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>LOG=DEBUG ./test-tcp --filter &quot;conn_init/3way_states&quot;
</pre></div>
</div>
</div>
<div class="section" id="producing-a-pcap-file">
<h3>Producing a pcap file<a class="headerlink" href="testing.html#producing-a-pcap-file" title="Permalink to this headline">¶</a></h3>
<p>Instead of reading through the log output, it can be useful to analyze the packets that were actually
sent during the test. chiTCP can produce a “pcap” file that can be opened with Wireshark. This can
help you verify whether all the values in the TCP packets are set to the correct values, since
Wireshark will “dissect” your TCP packets just like it would any TCP packet (and will highlight any
issues).</p>
<p>To produce a pcap file, simply include <code class="docutils literal notranslate"><span class="pre">PCAP=FILENAME</span></code> before <code class="docutils literal notranslate"><span class="pre">tests/test-tcp</span></code>, replacing
<code class="docutils literal notranslate"><span class="pre">FILENAME</span></code> with a name for the pcap file. For example, if we ran the following test,
which has packets arrive out of order:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>PCAP=out_of_order.pcap ./test-tcp --filter &quot;unreliable_data_transfer/out_of_order_1&quot;
</pre></div>
</div>
<p>And then open <code class="docutils literal notranslate"><span class="pre">out_of_order.pcap</span></code> in Wireshark, we can see that it correctly detects
that one of the packets arrived out of order:</p>
<img alt="../_images/out_of_order_wireshark.png" src="../_images/out_of_order_wireshark.png" />
<p>Finally, take into account that the <code class="docutils literal notranslate"><span class="pre">tests/pcap/</span></code> directory contains pcap files generated
with the chiTCP reference solution. These files can give you a better sense of what the
expected behaviour is on any given test.</p>
</div>
<div class="section" id="using-gdb-to-debug-a-test">
<h3>Using gdb to debug a test<a class="headerlink" href="testing.html#using-gdb-to-debug-a-test" title="Permalink to this headline">¶</a></h3>
<p>To run gdb with a single test, you will need to run the test you want to debug in one terminal,
and gdb in a separate terminal. First, run the test like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./test-tcp --debug=gdb --debug-transport=tcp:PORT --filter &quot;TEST&quot;
</pre></div>
</div>
<p>Replace <code class="docutils literal notranslate"><span class="pre">TEST</span></code> with the test you want to debug, and substitute <code class="docutils literal notranslate"><span class="pre">PORT</span></code> with a random port number.
By default, the tests will use <code class="docutils literal notranslate"><span class="pre">1234</span></code> but, if you are on a machine with multiple users, other users
may be trying to use that port.</p>
<p>Then, on another terminal, run this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>gdb ./test-tcp
</pre></div>
</div>
<p>On the GDB prompt, run this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>target remote localhost:PORT
</pre></div>
</div>
<p>Substituting <code class="docutils literal notranslate"><span class="pre">PORT</span></code> with the same port you used earlier.</p>
<p>Now, just use gdb as usual (note that you have to use the <code class="docutils literal notranslate"><span class="pre">continue</span></code> command instead
of the <code class="docutils literal notranslate"><span class="pre">run</span></code> command to ge the test running)</p>
</div>
<div class="section" id="running-valgrind-on-a-test">
<h3>Running Valgrind on a test<a class="headerlink" href="testing.html#running-valgrind-on-a-test" title="Permalink to this headline">¶</a></h3>
<p>To run Valgrind on a single test, run the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>valgrind ./test-tcp --filter &quot;TEST&quot;
</pre></div>
</div>
<p>Replace <code class="docutils literal notranslate"><span class="pre">TEST</span></code> with the test you want to run.</p>
</div>
<div class="section" id="running-the-tests-on-machines-with-multiple-users">
<h3>Running the tests on machines with multiple users<a class="headerlink" href="testing.html#running-the-tests-on-machines-with-multiple-users" title="Permalink to this headline">¶</a></h3>
<p>The tests internally run the chiTCP daemon which, just like the
regular <code class="docutils literal notranslate"><span class="pre">chitcpd</span></code> executable, will need a TCP port and a UNIX socket.
If you are on a machine with multiple users, then more than more
user may try to use the default port (23300). As with <code class="docutils literal notranslate"><span class="pre">chitcpd</span></code>,
make sure you run the following on any terminal where you run the
tests:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>export CHITCPD_PORT=30287  # Substitute for a different number
export CHITCPD_SOCK=/tmp/chitcpd.socket.$USER
</pre></div>
</div>
</div>
</div>
<div class="section" id="echo-server-and-client">
<h2>Echo server and client<a class="headerlink" href="testing.html#echo-server-and-client" title="Permalink to this headline">¶</a></h2>
<p>The automated tests will barrel through all the steps involved in each
particular test, which can make it hard to observe what happens at each
point. When you start developing your TCP implementation, we suggest you
use the <code class="docutils literal notranslate"><span class="pre">echo-server</span></code> and <code class="docutils literal notranslate"><span class="pre">echo-client</span></code> sample programs if you need
to run through your code step by step (these sample programs will
be built when you run <code class="docutils literal notranslate"><span class="pre">make</span></code>).</p>
<p><code class="docutils literal notranslate"><span class="pre">echo-server</span></code> and <code class="docutils literal notranslate"><span class="pre">echo-client</span></code> are a basic implementation of an echo server
and client. The echo server creates a passive socket on port 7 and, when a
client connects on that port, every byte the client sends will be sent back
verbatim. It is a simple way of testing that basic operations, like connecting
or sending small messages, work correctly.</p>
<p>Take into account that <code class="docutils literal notranslate"><span class="pre">echo-server</span></code> and <code class="docutils literal notranslate"><span class="pre">echo-client</span></code> both use the <em>chisocket</em>
library. This means that you <strong>must</strong> run <code class="docutils literal notranslate"><span class="pre">chitcpd</span></code> on the same machine you’re running
<code class="docutils literal notranslate"><span class="pre">echo-server</span></code> and <code class="docutils literal notranslate"><span class="pre">echo-client</span></code>. Otherwise, the chisocket library will not work.</p>
<p>When testing with these applications, we suggest you run <code class="docutils literal notranslate"><span class="pre">chitcpd</span></code> with option
<code class="docutils literal notranslate"><span class="pre">-vvv</span></code>. This will print detailed output about what your TCP implementation is
doing, including changes in the TCP variables. Additionally, you can run
<code class="docutils literal notranslate"><span class="pre">echo-server</span></code> and <code class="docutils literal notranslate"><span class="pre">echo-client</span></code> with a <code class="docutils literal notranslate"><span class="pre">-s</span></code> option that will allow you to
“step through” the stages of the TCP connection. For example, if you run
<code class="docutils literal notranslate"><span class="pre">echo-server</span> <span class="pre">-s</span></code>, you should step through the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Press any key to create the socket...
Press any key to bind the socket...
Press any key to make the socket listen...
Press any key to accept a connection...
</pre></div>
</div>
<p>After that last message, the server will block, waiting for connections.</p>
<p>Then, run <code class="docutils literal notranslate"><span class="pre">echo-client</span> <span class="pre">-s</span></code> and step through the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Press any key to create the socket...
Press any key to connect to the server...
</pre></div>
</div>
<p>As your TCP implementation sends and receives the packets for the three-way
handshake, you should see several messages appear on the <code class="docutils literal notranslate"><span class="pre">chitcpd</span></code> log. For
example, if you are sending the SYN packet correctly from the client to the
server, you should see something like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; Handling event APPLICATION_CONNECT on state CLOSED
&gt;&gt;&gt; TCP data BEFORE handling:
   ......................................................
                         CLOSED

            ISS:           0           IRS:           0
        SND.UNA:           0
        SND.NXT:           0       RCV.NXT:           0
        SND.WND:           0       RCV.WND:           0
    Send Buffer:    0 / 4096   Recv Buffer:    0 / 4096

       Pending packets:    0    Closing? NO
   ......................................................
&lt;&lt;&lt; TCP data AFTER handling:
   ......................................................
                         SYN_SENT

            ISS:          27           IRS:           0
        SND.UNA:          27
        SND.NXT:          28       RCV.NXT:           0
        SND.WND:           0       RCV.WND:        4096
    Send Buffer:    0 / 4096   Recv Buffer:    0 / 4096

       Pending packets:    0    Closing? NO
   ......................................................
</pre></div>
</div>
<p>Please note that the actual values of the TCP variables will probably be
different. To make this output even more useful, you may want to use
<code class="docutils literal notranslate"><span class="pre">chilog_tcp</span></code> to print out the contents of (1) any TCP packet you send, and
(2) any TCP packets you extract from the <code class="docutils literal notranslate"><span class="pre">pending_packets</span></code>. If you do this,
the output of <code class="docutils literal notranslate"><span class="pre">chitcpd</span></code> would look like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; Handling event APPLICATION_CONNECT on state CLOSED
&gt;&gt;&gt; TCP data BEFORE handling:
   ......................................................
                         CLOSED

            ISS:           0           IRS:           0
        SND.UNA:           0
        SND.NXT:           0       RCV.NXT:           0
        SND.WND:           0       RCV.WND:           0
    Send Buffer:    0 / 4096   Recv Buffer:    0 / 4096

       Pending packets:    0    Closing? NO
   ......................................................
Sending TCP packet
   ######################################################################
&gt;  Src: 49152  Dest: 7  Seq: 27  Ack: 0  Doff: 5  Win: 4096
&gt;  CWR: 0  ECE: 0  URG: 0  ACK: 0  PSH: 0  RST: 0  SYN: 1  FIN: 0
&gt;  No Payload
   ######################################################################
&lt;&lt;&lt; TCP data AFTER handling:
   ......................................................
                         SYN_SENT

            ISS:          27           IRS:           0
        SND.UNA:          27
        SND.NXT:          28       RCV.NXT:           0
        SND.WND:           0       RCV.WND:        4096
    Send Buffer:    0 / 4096   Recv Buffer:    0 / 4096

       Pending packets:    0    Closing? NO
   ......................................................
</pre></div>
</div>
<p>If the connection is established correctly, you should see this on the echo
server:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Got a connection from 127.0.0.1:49152
</pre></div>
</div>
<p>And the following on the echo client:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo&gt;
</pre></div>
</div>
<p>Now, if you type something and press Enter, and data transmission is correctly
implemented, you should get a copy of the message back:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo&gt; Hello, world!
Hello, world!
</pre></div>
</div>
<p>If you do not get the same message back, an error message will be printed.</p>
<p>To close the connection on the client side, just press Control+D. You will see
the following message:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Press any key to close connection...
</pre></div>
</div>
<p>After pressing a key, an active close will be initiated by the client, which
will send a <code class="docutils literal notranslate"><span class="pre">FIN</span></code> packet to the server. You will then see this on the server
side:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Peer has closed connection.
Press any key to close active socket...
</pre></div>
</div>
<p>This means the client has closed its side of the connection, but the server has
not. If you press any key, the server will send a <code class="docutils literal notranslate"><span class="pre">FIN</span></code> to the client. You
will then see this on the server:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Active socket closed.
Press any key to close passive socket...
</pre></div>
</div>
<p>Once you press any key, this will make the server stop listening on port 7.</p>
<p>Finally, both the client will prompt you to press any key to exit:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Press any key to exit...
</pre></div>
</div>
</div>
<div class="section" id="the-simple-tester">
<h2>The “simple tester”<a class="headerlink" href="testing.html#the-simple-tester" title="Permalink to this headline">¶</a></h2>
<p>The echo client and server can still be cumbersome for testing since they require
running three different programs (chitcpd, echo-server, and echo-client) and staying
on top of how each of them behaves.</p>
<p>So, we have an additional sample program, <code class="docutils literal notranslate"><span class="pre">simple-tester</span></code>, that runs a server and client simultaneously.
The client connects to the server, sends a single message, and then both of them initiate
a simultanous tear-down. This sample program is built along with the echo client/server
samples. To run it, make sure <code class="docutils literal notranslate"><span class="pre">chitcpd</span></code> is running (with option <code class="docutils literal notranslate"><span class="pre">-vv</span></code> as suggested earlier) and
then just run this from the <code class="docutils literal notranslate"><span class="pre">samples</span></code> directory:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./simple-tester
</pre></div>
</div>
<p>Assuming a correct TCP implementation, the simple tester will print out every TCP state
transition during the communication, as well as the value of the TCP variables:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Socket 1: [SND.UNA =   225  SND.NXT =   226  RCV.NXT =     0]              -&gt;     SYN_SENT
Socket 2: [SND.UNA =    99  SND.NXT =   100  RCV.NXT =   226]              -&gt;     SYN_RCVD
Socket 1: [SND.UNA =   226  SND.NXT =   226  RCV.NXT =   100]     SYN_SENT -&gt;  ESTABLISHED
Socket 2: [SND.UNA =   100  SND.NXT =   100  RCV.NXT =   226]     SYN_RCVD -&gt;  ESTABLISHED
Socket 1: Sent &#39;Hello, chiTCP!&#39;
Socket 2: Recv &#39;Hello, chiTCP!&#39;
Socket 1: [SND.UNA =   226  SND.NXT =   240  RCV.NXT =   100]  ESTABLISHED -&gt;   FIN_WAIT_1
Socket 2: [SND.UNA =   100  SND.NXT =   100  RCV.NXT =   240]  ESTABLISHED -&gt;   FIN_WAIT_1
Socket 1: [SND.UNA =   240  SND.NXT =   241  RCV.NXT =   101]   FIN_WAIT_1 -&gt;      CLOSING
Socket 2: [SND.UNA =   100  SND.NXT =   101  RCV.NXT =   241]   FIN_WAIT_1 -&gt;      CLOSING
Socket 1: [SND.UNA =   241  SND.NXT =   241  RCV.NXT =   101]      CLOSING -&gt;    TIME_WAIT
Socket 2: [SND.UNA =   101  SND.NXT =   101  RCV.NXT =   241]      CLOSING -&gt;    TIME_WAIT
Socket 1: [SND.UNA =   241  SND.NXT =   241  RCV.NXT =   101]    TIME_WAIT -&gt;       CLOSED
Socket 2: [SND.UNA =   101  SND.NXT =   101  RCV.NXT =   241]    TIME_WAIT -&gt;       CLOSED
</pre></div>
</div>
<p>Socket 1 is the active opener, and Socket 2 is the passive opener (note: sometimes the active
opener will get Socket 0). Although you may see different values for the Initial Sequence Number,
the relative progression of the TCP variables should be the same. Similarly, the order of the
state transitions may be slightly different than shown above.</p>
</div>
<div class="section" id="id1">
<h2>Producing a pcap file<a class="headerlink" href="testing.html#id1" title="Permalink to this headline">¶</a></h2>
<p>Similarly to how the tests produce a pcap file that can be opened with Wireshark,
you can also tell <code class="docutils literal notranslate"><span class="pre">chitcpd</span></code> to log all its packets to a pcap file. Simply run
<code class="docutils literal notranslate"><span class="pre">chitcpd</span></code> with a <code class="docutils literal notranslate"><span class="pre">-c</span> <span class="pre">CAPFILE</span></code> option. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./chitcpd -c packets.cap
</pre></div>
</div>
</div>
<div class="section" id="wireshark-dissector">
<h2>Wireshark dissector<a class="headerlink" href="testing.html#wireshark-dissector" title="Permalink to this headline">¶</a></h2>
<p>We provide a Wireshark dissector, in the <code class="docutils literal notranslate"><span class="pre">wireshark_dissector</span></code> directory,
that you can use to easily see what is <em>actually</em> sent through the network
during a chiTCP connection. Please note that, if you need to look at the
packets sent during a given test or communication, producing a pcap
file is generally enough. However, if you need to go further down the
debugging rabbit hole, and see <em>exactly</em> what is being sent on the network,
you can use this dissector to actually look at the chiTCP traffic.</p>
<p>To install the dissector, follow these steps:</p>
<ol class="arabic">
<li><p>Make sure Lua with support for the “bit” library is installed. On
Ubuntu, this requires installing the following packages:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>lua5.2
lua-bitop
</pre></div>
</div>
</li>
<li><p>Copy the file <code class="docutils literal notranslate"><span class="pre">chitcp.lua</span></code> to <code class="docutils literal notranslate"><span class="pre">~/.wireshark/plugins</span></code></p></li>
<li><p>Lua plugins will not work if Wireshark is run as root. You will need
to give your user permissions to perform network captures without
having root privileges. If you are on a Debian/Ubuntu system, just
follow these instructions:</p>
<p><a class="reference external" href="http://ask.wireshark.org/questions/7523/ubuntu-machine-no-interfaces-listed">http://ask.wireshark.org/questions/7523/ubuntu-machine-no-interfaces-listed</a></p>
<p>For other systems, there are general instructions here:</p>
<p><a class="reference external" href="http://wiki.wireshark.org/CaptureSetup/CapturePrivileges">http://wiki.wireshark.org/CaptureSetup/CapturePrivileges</a></p>
</li>
</ol>
<div class="section" id="using-the-dissector">
<h3>Using the dissector<a class="headerlink" href="testing.html#using-the-dissector" title="Permalink to this headline">¶</a></h3>
<p>Since, as far as Wireshark is concerned, the ChiTCP packet is application-level
data, we need to use a specific port so Wireshark will know what TCP packets
contain ChiTCP packets. The default is 23300, although this can be changed
in <code class="docutils literal notranslate"><span class="pre">chitcp.lua</span></code>.</p>
<p>Wireshark should automatically detect the new dissector. If you capture TCP
packets, it should flag non-empty packets on port 23300 as ChiTCP packets. You
should be able to see the ChiTCP header fields in human-readable format right
below the TCP packet data. Wireshark will also helpfully dissect <em>your</em> TCP packet
as well as its payload.</p>
<p>For example, this is what wireshark should look like if you use the sample echo
server/client:</p>
<div class="figure align-default" id="id2">
<img alt="Wireshark running chiTCP dissector" src="../_images/wireshark.png" />
<p class="caption"><span class="caption-text">Wireshark running chiTCP dissector</span><a class="headerlink" href="testing.html#id2" title="Permalink to this image">¶</a></p>
</div>
<p>Note how you can also apply the filter <code class="docutils literal notranslate"><span class="pre">chitcp</span></code>, and that will show only the
TCP packets that contain ChiTCP packets.</p>
</div>
</div>
</div>


    </div>
    
<nav class="related">
  <ul class="pager">
    <li class="previous">
    <a href="assignment2.html" title="Previous Chapter: Assignment 2: TCP over an Unreliable Network"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Assignment 2: TCP over an Unreliable Network</span>
    </a>    
    </li>
    <li class="next">
    <a href="../chirouter/index.html" title="Next Chapter: chirouter"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">chirouter &raquo;</span>
    </a>    
    </li>
  </ul>
</nav>

  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="testing.html#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2010-2022, The University of Chicago.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>